<!DOCTYPE html>
<html>
<head>
    <title>Tweet Analysis</title>
    {% load static %}
    <!-- Link to external CSS file -->
    <link rel="stylesheet" type="text/css" href="{% static 'css/styles.css' %}">
    <script>
        // Function to show the loading overlay
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        // Function to display the modal for adding a comment
        function showModal(tweetId) {
            document.getElementById('modal').style.display = 'block';
            document.getElementById('tweetId').value = tweetId;
        }

        // Function to close the modal
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // Function to save a comment in local storage
        function saveComment() {
            const tweetId = document.getElementById('tweetId').value;
            const comment = document.getElementById('comment').value;
            localStorage.setItem(tweetId, comment);
            closeModal();
            displayComments();
        }

        // Function to delete a comment from local storage
        function deleteComment(tweetId) {
            localStorage.removeItem(tweetId);
            displayComments();
        }

        // Function to display comments from local storage
        function displayComments() {
            const tweets = document.querySelectorAll('.tweet');
            tweets.forEach(tweet => {
                const tweetId = tweet.getAttribute('data-id');
                const comment = localStorage.getItem(tweetId);
                if (comment) {
                    tweet.querySelector('.comment').innerText = comment;
                } else {
                    tweet.querySelector('.comment').innerText = '';
                }
            });
        }

        // Event listener to display comments when the document is loaded
        document.addEventListener('DOMContentLoaded', displayComments);
    </script>
</head>
<body>
    <header>
        <div class="container">
            <div id="branding">
                <h1>SentiScan</h1>
                <h3>Tweet Analysis</h3>
            </div>
            <nav>
                <ul>
                    <li><a href="/">Home</a></li>
                    <li><a href="{% url 'graphs' %}">Graphs</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div id="loading" class="loading">Processing...</div>

    <div class="container">
        <h2>Total Tweets Processed: {{ total_tweets }}</h2>

        <!-- Form to add tweets range -->
        <form method="post" action="" onsubmit="showLoading()">
            {% csrf_token %}
            <label for="start">Start Line:</label>
            <input type="number" name="start" id="start" min="0" required>

            <label for="end">End Line:</label>
            <input type="number" name="end" id="end" min="1" required>

            <button type="submit">Add Tweets</button>
        </form>

        <!-- Form to filter tweets -->
        <form method="get" action="">
            <label for="sentiment">Sentiment:</label>
            <select name="sentiment" id="sentiment">
                <option value="">All</option>
                <option value="Positive" {% if request.GET.sentiment == 'Positive' %}selected{% endif %}>Positive</option>
                <option value="Neutral" {% if request.GET.sentiment == 'Neutral' %}selected{% endif %}>Neutral</option>
                <option value="Negative" {% if request.GET.sentiment == 'Negative' %}selected{% endif %}>Negative</option>
            </select>

            <label for="min_confidence">Minimum Confidence:</label>
            <input type="number" step="0.01" name="min_confidence" id="min_confidence" min="0" max="100" value="{{ request.GET.min_confidence }}">

            <label for="keyword">Keyword:</label>
            <input type="text" name="keyword" id="keyword" value="{{ request.GET.keyword }}">

            <button type="submit">Filter</button>
        </form>

        <!-- Form to export filtered tweets to CSV -->
        <form method="get" action="{% url 'export_tweets' %}">
            {% csrf_token %}
            <input type="hidden" name="sentiment" value="{{ request.GET.sentiment }}">
            <input type="hidden" name="min_confidence" value="{{ request.GET.min_confidence }}">
            <input type="hidden" name="keyword" value="{{ request.GET.keyword }}">
            <button type="submit">Export to CSV</button>
        </form>

        <!-- Table displaying tweets -->
        <table>
            <tr>
                <th>Tweet</th>
                <th>Sentiment</th>
                <th>Confidence</th>
                <th>Comment</th>
                <th>Action</th>
            </tr>
            {% for tweet in tweets %}
            <tr class="tweet" data-id="{{ tweet.id }}">
                <td>{{ tweet.tweet }}</td>
                <td>{{ tweet.sentiment }}</td>
                <td>{{ tweet.confidence }}</td>
                <td class="comment"></td>
                <td>
                    <span class="comment-button" onclick="showModal('{{ tweet.id }}')">+</span>
                    <span class="delete-button" onclick="deleteComment('{{ tweet.id }}')">-</span>
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>

    <!-- Modal for entering comments -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Enter Comment:</h2>
            <input type="hidden" id="tweetId">
            <textarea id="comment" rows="4" cols="50"></textarea>
            <button onclick="saveComment()">Save Comment</button>
        </div>
    </div>
</body>
</html>
